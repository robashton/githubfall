<html>
  <script type="text/javascript" src="socket.io/socket.io.js"></script>
  <script type="text/javascript" src="jquery-1.7.2.min.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css"></script>

  <script type="text/javascript">

    var BUCKET_WIDTH = 600;
    var lastScale = 1.0;

    var showEvent = function(event, x, y) {
      var display = $('#event-display');
      display.css({
        left: x + 'px',
        top: y + 'px'
      });
      display.find('.author').text(event.actor.login);

      var commitscontainer = display.find('.commits');
      commitscontainer.html('');
      for(var i in event.payload.commits) {
        var commit = event.payload.commits[i];
        commitscontainer.append($('<span/>').text(commit.message));
      }
      $('#event-display').show();
    }

    var onElementMouseEnter = function(e) {
      var event = $(this).data('event');
      showEvent(event, e.pageX, e.pageY);
    };

    var onElementMouseLeave = function(e) {
       $('#event-display').hide();
    };

    var Bucket = function(element) {
      this.element = element;
      this.events = [];
    };
    Bucket.prototype = {
      add: function(event) {
        var html = this.createEventHtml(event);
        this.events.push(event);
        this.element.append(html);
        html.on('mouseenter', onElementMouseEnter);
        html.on('mouseleave', onElementMouseLeave);
        this.highlightItem(html, 2);
      },
      count: function() {
        return this.events.length;
      },
      height: function() {
        return this.element.height(); // for now
      },
      width: function() {
        return this.element.width(); 
      },
      createEventHtml: function(data) {
        var element = $('<div />')
                        .addClass('push');

        element.append($('<div/>')
                        .addClass('author')
                          .append($('<p/>').text(data.actor.login))
                          .append($('<img/>').attr('src', data.actor.avatar_url))
                      );
        element.data('event', data);
        return element;
      },
      highlightItem: function(html, seconds) {
        html.addClass("highlighted");
        setTimeout(function() {
          html.removeClass("highlighted");
        }, seconds * 1000);
      }
    };

    var buckets = {};
    var bucketCount = 0;

    var getBucketForLanguage = function(language, cb) {
      language = language || 'Unknown';
      var bucket = buckets[language];
      if(bucket) return cb(bucket);


      bucket = $('<div/>')
                .attr('id', language)
                .css({left: bucketCount * BUCKET_WIDTH + 'px'})
                .addClass('bucket');

      bucket.append($('<h1/>')
                       .text(language)
                   );


      $('#container').append(bucket);
      buckets[language] = new Bucket(bucket);
      bucketCount++;

      return cb(bucket);
    };

    var appendItemToDocument = function(data) {
      getBucketForLanguage(data.language, function(bucket) {
        bucket.add(data);
      });
    };

    $(document).ready(function(){
      var socket = io.connect();
      socket.on('push', appendItemToDocument);
    });

    var recalculateScale = function() {
      var container = $('#container');
      var doc = $(window);

      var containerHeight = 0;
      var containerWidth = 0;
      var totalItems = 0;

      for(var i in buckets) {
        var bucket = buckets[i];
        totalItems += bucket.count();
      }
      if(totalItems === 0) return;

      for(var i in buckets) {
        var bucket = buckets[i];
        var bucketHeight = bucket.height();
        containerHeight = Math.max(containerHeight,  bucketHeight);
        containerWidth += bucket.width();
      }
      containerWidth += BUCKET_WIDTH; 

      var x = doc.width() / containerWidth;
      var y = doc.height() / containerHeight;
      var scale = Math.min(x, y);
      scale = Math.min(scale, 0.3);

      var scaleDifference = lastScale - scale;
      if(scaleDifference < 0.01) return;

      lastScale = scale;
      container.css('-webkit-transform', 'scale(' + scale + ')'); 
    };

    setInterval(recalculateScale, 500);

  </script>
  <body>
    <h1 class="title">Github Live</h1>
    <div id="outerContainer">
      <div id="container">

      </div>
      <div id="dialog-container">
        <div id="event-display">
          <h4 class="author"></h4>
          <div class="commits">
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
